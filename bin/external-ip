#!/usr/bin/env bash

cacheFile="$HOME/.externalip"

if [[ "$1" = "-r" ]]
then
    rm $cacheFile
else
    modified=$(expr $(date +%s) - $(date +%s -r $cacheFile))
    if [[ $modified -gt 1800 ]]
    then
        rm $cacheFile
    fi
fi


if [[ ! -f "$cacheFile" ]]
then
    touch $cacheFile
fi

cachedIp=$(cat $cacheFile)
if [[ -z "$cachedIp" ]] || [[ "$1" == "-f" ]]
then
    externalIp=$(curl -s ifconfig.me)
fi

if [[ "$1" == "-f" ]]
then
    echo $externalIp
else
    if [[ -z $cachedIp ]]
    then
        echo $externalIp > $cacheFile
        echo $externalIp
    else
        echo $cachedIp
    fi
fi
